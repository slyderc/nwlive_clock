# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

OnAirScreen is a professional broadcast studio "OnAir Lamp" application built with **PyQt6**. It displays status indicators (LEDs), timers, text messages, weather, and a digital clock. The app is controlled via keyboard shortcuts, UDP/HTTP APIs, WebSockets, and MQTT (with Home Assistant integration).

## Build & Development Commands

```bash
# Build all generated UI/resource files (required after modifying .ui or .qrc files)
make all

# Clean generated files
make clean

# Run the application
python start.py
python start.py --loglevel DEBUG    # With debug logging
python start.py --fullscreen        # Fullscreen mode

# Run tests
pytest                              # All tests
pytest tests/test_command_handler.py -v  # Specific module
pytest -m "not slow"                # Skip slow tests
pytest -m "unit"                    # Unit tests only
pytest -m "integration"             # Integration tests only

# Install dependencies
pip install -r requirements.txt
```

## Architecture

### Generated Files (DO NOT EDIT DIRECTLY)
These are auto-generated by `make all` from Qt Designer files:
- `mainscreen.py` ← `mainscreen.ui` (pyuic6)
- `settings.py` ← `settings.ui` (pyuic6)
- `resources_rc.py` ← `resources.qrc` (Qt rcc, ~3MB embedded images/fonts)

### Core Modules

| Module | Purpose |
|--------|---------|
| `start.py` | Main entry point, `MainScreen` class, app initialization |
| `command_handler.py` | Parse/validate UDP/HTTP/MQTT commands |
| `network.py` | UDP, HTTP REST API, WebSocket servers |
| `mqtt_client.py` | MQTT integration with Home Assistant Autodiscovery |
| `exceptions.py` | Unified exception hierarchy (all inherit from `OnAirScreenError`) |
| `defaults.py` | Application-wide default values |
| `settings_functions.py` | Settings UI, persistence, presets, validation |

### Manager Pattern
Separate modules handle distinct concerns:
- `timer_manager.py` - QTimer objects for LED flashing
- `ntp_manager.py` - NTP sync checking (background thread)
- `ui_updater.py` - Periodic UI refresh (date, time, backtiming)
- `status_exporter.py` - JSON status export for APIs
- `warning_manager.py` - Priority-based warnings (-1=NTP, 0-2=user)
- `hotkey_manager.py` - Keyboard shortcut registration
- `event_logger.py` - Structured event logging

### Custom Widgets
- `clockwidget.py` - Digital/analog clock display
- `weatherwidget.py` - Weather display with OpenWeatherMap API

## Network Ports & APIs

| Port | Protocol | Purpose |
|------|----------|---------|
| 3310 | UDP | Command reception (multicast: 239.194.0.1) |
| 8010 | HTTP | REST API, Web UI, WebSocket (/ws) |

### API Command Format
```
LED1-4:[ON|OFF|TOGGLE]
AIR1-4:[ON|OFF|RESET|TOGGLE]
AIR3TIME:seconds
NOW:TEXT, NEXT:TEXT, WARN:TEXT, WARN:Prio:TEXT
CMD:REBOOT, CMD:SHUTDOWN, CMD:QUIT
CONF:Group:key=value
```

### REST Endpoints
- `GET /` - Web UI
- `GET /api/status` - JSON status
- `GET /api/command?cmd=...` - Execute command

## Error Handling Pattern

All custom exceptions inherit from `OnAirScreenError` with context support:

```python
from exceptions import CommandValidationError, log_exception

try:
    # operation
except CommandValidationError as e:
    log_exception(logger, e, use_exc_info=False)  # Expected errors: no traceback
```

HTTP responses map exceptions to status codes:
- Validation/Parse errors → 400
- Unknown commands → 404
- Port/Permission errors → 503
- Serialization errors → 500

## Configuration

Settings stored via Qt `QSettings` (platform-native: plist on macOS, Registry on Windows, INI on Linux).

Default values are centralized in `defaults.py` - use `get_default(group, key)` for lookups.

## Testing

- 583+ tests across 16 modules
- Markers: `@pytest.mark.slow`, `@pytest.mark.integration`, `@pytest.mark.unit`, `@pytest.mark.gui`
- Uses `pytest-asyncio` for async tests
- Test files mirror source: `tests/test_<module>.py`

## Key Patterns

1. **Thread-safe command execution**: `CommandSignal` uses Qt signals to marshal commands to main thread
2. **Input sanitization**: `command_handler.py` removes control chars and dangerous patterns
3. **Status broadcast**: State changes push to WebSocket clients and MQTT
4. **Preset system**: Save/load full configurations as JSON files via settings dialog
